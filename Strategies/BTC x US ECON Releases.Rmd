---
title: "Bitcoin Analysis"
author: "Matthew Adams"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(httr2)
library(cryptoQuotes)
library(tidyverse)
library(xts)
library(tictoc)
```

```{r Crypto Testing}
# List available exchanges
available_exchanges()

# List available intervals
available_intervals(source = "binance", futures = TRUE)

# List available tickers
tickers <- available_tickers(source = "binance", futures = FALSE)

# Search tickers for BTC
any(grepl("^BTC", tickers)) 
```

```{r Crypto Sample Pull}
# XTS object with Bitcoin data
BTC <- get_quote(
  ticker   = 'BTCUSDT',
  source   = 'binance',
  futures  = FALSE,
  interval = '1d',
  from     = Sys.Date() - 199
)

# Create tibble with Bitcoin data
btc_tbl <- tibble(
  datetime = index(BTC),
  open     = coredata(BTC)[, "open"],
  high     = coredata(BTC)[, "high"],
  low      = coredata(BTC)[, "low"],
  close    = coredata(BTC)[, "close"],
  volume   = coredata(BTC)[, "volume"]
) %>%
  mutate(datetime = as_datetime(datetime, tz = "UTC"))

btc_tbl

```

```{r Paged Historical Pull}

tic()

# Function to extract historical prices
binanceus_klines_once <- function(symbol, interval, start_time, end_time, limit = 1000) {
  req <- request("https://api.binance.us/api/v3/klines") |>
    req_url_query(
      symbol    = symbol,
      interval  = interval,  # e.g., "30m"
      startTime = as.integer(as.POSIXct(start_time, tz = "UTC")) * 1000,
      endTime   = as.integer(as.POSIXct(end_time,   tz = "UTC")) * 1000,
      limit     = limit      # default 500, max 1000 on Binance.US
    ) |>
    req_perform()
  
  raw <- resp_body_json(req)
  if (length(raw) == 0) return(tibble())
  
  cols <- c("open_time","open","high","low","close","volume",
            "close_time","qav","trades","tbbav","tbqav","ignore")
  
  as_tibble(do.call(rbind, raw), .name_repair = "minimal") |>
    setNames(cols) |>
    mutate(
      open_time  = as_datetime(as.numeric(open_time)/1000,  tz = "UTC"),
      close_time = as_datetime(as.numeric(close_time)/1000, tz = "UTC"),
      across(c(open, high, low, close, volume, qav, tbbav, tbqav), as.numeric),
      trades = as.integer(trades)
    ) |>
    transmute(datetime = open_time, open, high, low, close, volume, close_time, trades)
}

get_klines_us <- function(symbol   = "BTCUSDT",
                          interval = "30m",
                          start    = as_datetime("2020-01-01 00:00:00", tz = "UTC"),
                          end      = now(tzone = "UTC"),
                          limit    = 1000,
                          pause_s  = 0.5) {
  step <- dminutes(30) * limit     # ~20.8 days per page at 30m
  cursor <- as_datetime(start, tz = "UTC"); end <- as_datetime(end, tz = "UTC")
  out <- list()
  while (cursor < end) {
    page_end <- min(cursor + step, end)
    chunk <- binanceus_klines_once(symbol, interval, cursor, page_end, limit = limit)
    if (nrow(chunk) == 0) break
    out[[length(out) + 1]] <- chunk
    cursor <- max(chunk$datetime) + dminutes(30)
    Sys.sleep(pause_s)
  }
  bind_rows(out) |> distinct(datetime, .keep_all = TRUE) |> arrange(datetime)
}

btc_30m_1y <- get_klines_us(
  symbol   = "BTCUSDT",   # on Binance.US this usually exists; if not, try "BTCUSD"
  interval = "30m",
  start    = Sys.Date() - 365,
  end      = lubridate::now(tzone = "UTC")
)
nrow(btc_30m_1y); range(btc_30m_1y$datetime)

toc()

# Plot the results
ggplot(data = btc_30m_1y, aes(x = datetime, y = close)) +
  geom_point(size = .5)
```
